name: Code Quality & Syntax

on:
  push:
    branches: [ main, master ]
    paths:
      - 'site/**/*.php'
      - 'tests/**/*.php'
      - '.github/workflows/syntax.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'site/**/*.php'
      - 'tests/**/*.php'

jobs:
  syntax-check:
    runs-on: ubuntu-latest
    name: PHP Syntax & Quality Check

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, iconv, intl

    - name: PHP Syntax Check
      run: |
        echo "ğŸ” Checking PHP syntax..."
        find site -name "*.php" -print0 | xargs -0 -I {} php -l {}
        if [ -d "tests" ]; then
          find tests -name "*.php" -print0 | xargs -0 -I {} php -l {}
        fi
        echo "âœ… PHP syntax check completed"

    - name: Download PHP CodeSniffer
      run: |
        echo "ğŸ“¥ Downloading PHP CodeSniffer..."
        curl -OL https://squizlabs.github.io/PHP_CodeSniffer/phpcs.phar
        chmod +x phpcs.phar

    - name: Code Style Check (PSR-12)
      run: |
        echo "ğŸ¯ Checking code style (PSR-12)..."
        php phpcs.phar --standard=PSR12 --extensions=php site/ || echo "âš ï¸  Code style issues found (not blocking)"
        if [ -d "tests" ]; then
          php phpcs.phar --standard=PSR12 --extensions=php tests/ || echo "âš ï¸  Test code style issues found (not blocking)"
        fi

    - name: Validate Composer
      run: |
        echo "ğŸ“‹ Validating composer configuration..."
        composer validate --strict
        
        # VÃ©rification du lock file (non-bloquante)
        if ! composer validate --lock --quiet; then
          echo "âš ï¸ composer.lock might need update"
          echo "ğŸ’¡ Consider running 'composer update --lock' locally"
        else
          echo "âœ… composer.lock is up to date"
        fi
        echo "âœ… Composer validation completed"

    - name: Summary
      run: |
        echo ""
        echo "ğŸ‰ Code quality check completed!"
        echo ""
        echo "âœ… PHP Syntax: Verified"
        echo "ğŸ“‹ Code Style: PSR-12 checked"
        echo "ğŸ“¦ Composer: Validated"
        echo ""
        echo "ğŸ’¡ This workflow ensures basic code quality standards"
